<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- PWA를 위한 메타 태그 추가 -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <link rel="manifest" href="/manifest.json">

    <title>Win-Win-Log: B2B 영업 통합 다이어리</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            color: #1f2937;
        }
        .container {
            max-width: 1024px;
        }
        .bg-card {
            background-color: #ffffff;
            border-radius: 1.5rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .nav-link {
            transition: all 0.2s ease-in-out;
            cursor: pointer;
        }
        .nav-link.active {
            color: #3b82f6;
            border-color: #3b82f6;
            font-weight: 600;
        }
        textarea.handwritten {
            font-family: 'Inter', sans-serif;
            line-height: 1.5;
            min-height: 200px;
        }
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal-content {
            background-color: white;
            padding: 2rem;
            border-radius: 1rem;
            max-width: 90%;
            max-height: 90%;
            overflow-y: auto;
            position: relative;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        }
        .hidden {
            display: none;
        }
        #roi-page {
            min-height: 80vh;
        }
        .roi-input-field {
            margin-bottom: 1rem;
        }
        .roi-input-field label {
            font-weight: 500;
        }
        .roi-input-field input {
            width: 100%;
            padding: 0.5rem;
            border-radius: 0.5rem;
            border: 1px solid #d1d5db;
        }
        .chart-container {
            position: relative;
            height: 40vh;
            margin-bottom: 2rem;
        }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.7.1/chart.min.js"></script>
</head>
<body class="p-4 md:p-8">
    <!-- 메인 앱 컨테이너 -->
    <div id="main-app" class="container mx-auto">
        <!-- 헤더 및 내비게이션 -->
        <header class="flex flex-col md:flex-row items-center justify-between mb-8 md:mb-12">
            <h1 id="main-logo" class="text-3xl md:text-4xl font-bold text-gray-800 mb-4 md:mb-0 cursor-pointer">
                Win-Win-Log
            </h1>
            <!-- 탭 내비게이션 -->
            <nav class="flex space-x-2 md:space-x-4">
                <a href="#" class="nav-link text-gray-500 px-4 py-2 border-b-2 border-transparent active" data-target="meeting-log">
                    <span class="text-sm md:text-lg">미팅 기록</span>
                </a>
                <a href="#" class="nav-link text-gray-500 px-4 py-2 border-b-2 border-transparent" data-target="records-list">
                    <span class="text-sm md:text-lg">기록 관리</span>
                </a>
                <a href="#" class="nav-link text-gray-500 px-4 py-2 border-b-2 border-transparent" data-target="brainstorming">
                    <span class="text-sm md:text-lg">브레인스토밍</span>
                </a>
                <a href="#" class="nav-link text-gray-500 px-4 py-2 border-b-2 border-transparent" data-target="crm">
                    <span class="text-sm md:text-lg">고객 관계도</span>
                </a>
                <a href="#" class="nav-link text-gray-500 px-4 py-2 border-b-2 border-transparent" data-target="analysis">
                    <span class="text-sm md:text-lg">성공/실패 분석</span>
                </a>
            </nav>
        </header>

        <!-- 템플릿 콘텐츠 섹션 -->
        <main class="space-y-12">
            <!-- 1. 미팅 기록 템플릿 (Create & Update) -->
            <section id="meeting-log" class="template-section bg-card p-6 md:p-12">
                <h2 class="text-2xl md:text-3xl font-bold mb-6 text-gray-800">미팅 기록</h2>
                <!-- 현재 수정 중인 기록의 ID를 저장하는 숨김 필드 -->
                <input type="hidden" id="current-record-id-meeting">
                
                <!-- 미팅 유형 선택 -->
                <div class="mb-8">
                    <label class="block text-sm md:text-base font-medium text-gray-600 mb-2">미팅 유형</label>
                    <div class="flex space-x-4">
                        <label class="flex items-center">
                            <input type="radio" name="meeting-type" value="customer" class="mr-2 text-blue-500 focus:ring-blue-500" checked>
                            <span class="text-sm md:text-base">고객 미팅</span>
                        </label>
                        <label class="flex items-center">
                            <input type="radio" name="meeting-type" value="internal" class="mr-2 text-blue-500 focus:ring-blue-500">
                            <span class="text-sm md:text-base">내부 미팅</span>
                        </label>
                    </div>
                </div>

                <!-- 고객 미팅 항목 (기본) -->
                <div id="customer-meeting-fields">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                        <!-- 기본 정보 -->
                        <div class="bg-gray-50 p-6 rounded-2xl shadow-inner">
                            <div class="space-y-4">
                                <div>
                                    <label for="client-name-meeting" class="block text-sm md:text-base font-medium text-gray-600">고객사명</label>
                                    <input type="text" id="client-name-meeting" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2" placeholder="예: 구글 코리아">
                                </div>
                                <div>
                                    <label for="contact-name-meeting" class="block text-sm md:text-base font-medium text-gray-600">담당자</label>
                                    <input type="text" id="contact-name-meeting" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2" placeholder="예: 홍길동 팀장">
                                </div>
                                <div>
                                    <label for="author-name" class="block text-sm md:text-base font-medium text-gray-600">작성자</label>
                                    <input type="text" id="author-name" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2" placeholder="예: 김지훈">
                                </div>
                                <div>
                                    <label for="meeting-date" class="block text-sm md:text-base font-medium text-gray-600">미팅 날짜</label>
                                    <input type="date" id="meeting-date" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2">
                                </div>
                                <div>
                                    <label for="expected-deal" class="block text-sm md:text-base font-medium text-gray-600">예상 계약 금액 (만원)</label>
                                    <input type="number" id="expected-deal" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2" placeholder="예: 5000">
                                </div>
                                <div>
                                    <label class="block text-sm md:text-base font-medium text-gray-600">영업 단계</label>
                                    <div class="mt-2 space-y-2">
                                        <label class="flex items-center"><input type="radio" name="sales-stage" value="discovery" class="mr-2 text-blue-500 focus:ring-blue-500" checked> Lead/Prospect (정보수집)</label>
                                        <label class="flex items-center"><input type="radio" name="sales-stage" value="proposal" class="mr-2 text-blue-500 focus:ring-blue-500"> Proposal (제안)</label>
                                        <label class="flex items-center"><input type="radio" name="sales-stage" value="closing" class="mr-2 text-blue-500 focus:ring-blue-500"> Closing (계약)</label>
                                    </div>
                                </div>
                                <div class="stage-fields" data-stage="discovery proposal closing">
                                    <label for="desired-system" class="block text-sm md:text-base font-medium text-gray-600">원하는 시스템/솔루션</label>
                                    <select id="desired-system" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2">
                                        <option value="">선택</option>
                                        <option value="MES">MES</option>
                                        <option value="EES">EES</option>
                                        <option value="EMS">EMS</option>
                                        <option value="QMS">QMS</option>
                                        <option value="SPC">SPC</option>
                                        <option value="TC">TC</option>
                                        <option value="AI">AI</option>
                                        <option value="DT">DT</option>
                                        <option value="APS">APS</option>
                                    </select>
                                </div>
                                <div class="stage-fields" data-stage="discovery proposal closing">
                                    <label for="implementation-timeline" class="block text-sm md:text-base font-medium text-gray-600">도입 시점</label>
                                    <select id="implementation-timeline" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2">
                                        <option value="">선택</option>
                                        <option value="1-3-months">1-3개월 이내</option>
                                        <option value="3-6-months">3-6개월 이내</option>
                                        <option value="6-12-months">6-12개월 이내</option>
                                        <option value="over-12-months">1년 이상</option>
                                    </select>
                                </div>
                                <div class="stage-fields" data-stage="discovery proposal closing">
                                    <label for="decision-method" class="block text-sm md:text-base font-medium text-gray-600">의사결정 방식</label>
                                    <select id="decision-method" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2">
                                        <option value="">선택</option>
                                        <option value="instant">즉시 결정</option>
                                        <option value="upper-level">상위 보고</option>
                                        <option value="majority">다수결 협의</option>
                                        <option value="rfp">RFP/입찰</option>
                                    </select>
                                </div>
                                <div class="mt-4 stage-fields" data-stage="discovery proposal closing">
                                    <label class="block text-sm md:text-base font-medium text-gray-600 mb-2">미팅 분위기</label>
                                    <div class="flex flex-wrap space-x-4">
                                        <label class="flex items-center"><input type="checkbox" name="meeting-mood" value="positive" class="mr-2 text-green-500 focus:ring-green-500"> 긍정적</label>
                                        <label class="flex items-center"><input type="checkbox" name="meeting-mood" value="negative" class="mr-2 text-red-500 focus:ring-red-500"> 부정적</label>
                                        <label class="flex items-center"><input type="checkbox" name="meeting-mood" value="neutral" class="mr-2 text-gray-500 focus:ring-gray-500"> 중립적</label>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="space-y-6">
                            <div class="stage-fields" data-stage="discovery proposal closing">
                                <label for="key-questions" class="block text-sm md:text-base font-medium text-gray-600">핵심 질문 기록</label>
                                <textarea id="key-questions" rows="4" class="handwritten mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-4" placeholder="고객에게 던진 핵심 질문과 답변을 기록하세요. (예: 기존 시스템의 가장 큰 불만은 무엇인가요?)"></textarea>
                            </div>
                            <div class="stage-fields" data-stage="discovery proposal closing">
                                <label for="pain-point" class="block text-sm md:text-base font-medium text-gray-600">고객의 Pain Point (고통점)</label>
                                <textarea id="pain-point" rows="4" class="handwritten mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-4" placeholder="고객이 겪고 있는 핵심 문제를 기록하세요."></textarea>
                            </div>
                            <div class="stage-fields" data-stage="discovery proposal closing">
                                <label for="needs" class="block text-sm md:text-base font-medium text-gray-600">고객의 Needs & Goals (니즈 및 목표)</label>
                                <textarea id="needs" rows="4" class="handwritten mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-4" placeholder="고객이 궁극적으로 얻고 싶은 것을 기록하세요."></textarea>
                            </div>
                            <div class="stage-fields hidden" data-stage="proposal closing">
                                <label for="proposal-details" class="block text-sm md:text-base font-medium text-gray-600">주요 제안 내용 및 협상</label>
                                <textarea id="proposal-details" rows="4" class="handwritten mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-4" placeholder="제안한 솔루션의 핵심과 협상 과정을 기록하세요. (예: 가격, 계약 조건 등)"></textarea>
                            </div>
                            <div class="stage-fields hidden" data-stage="proposal">
                                <label for="customer-objections" class="block text-sm md:text-base font-medium text-gray-600">고객의 주요 반대 의견</label>
                                <textarea id="customer-objections" rows="4" class="handwritten mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-4" placeholder="고객의 반대 의견과 이에 대한 해결 방안을 기록하세요."></textarea>
                            </div>
                            <div class="stage-fields hidden" data-stage="closing">
                                <label for="closing-outcome" class="block text-sm md:text-base font-medium text-gray-600">계약 결과 및 요인</label>
                                <textarea id="closing-outcome" rows="4" class="handwritten mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-4" placeholder="계약이 성공 또는 실패한 이유를 기록하세요."></textarea>
                            </div>
                            <div class="stage-fields" data-stage="discovery proposal closing">
                                <label for="competitor" class="block text-sm md:text-base font-medium text-gray-600">경쟁사 관련 언급</label>
                                <textarea id="competitor" rows="2" class="handwritten mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-4" placeholder="경쟁사 이름 및 고객의 평가를 기록하세요."></textarea>
                            </div>
                            <div class="stage-fields" data-stage="discovery proposal closing">
                                <label for="next-action" class="block text-sm md:text-base font-medium text-gray-600">Next Action Plan (다음 행동 계획)</label>
                                <textarea id="next-action" rows="4" class="handwritten mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-4" placeholder="미팅 후 해야 할 구체적인 행동을 기록하세요."></textarea>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 내부 미팅 항목 (숨김) -->
                <div id="internal-meeting-fields" class="hidden">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                        <div class="bg-gray-50 p-6 rounded-2xl shadow-inner">
                            <div class="space-y-4">
                                <div>
                                    <label for="client-name-internal" class="block text-sm md:text-base font-medium text-gray-600">고객사명 (관련)</label>
                                    <input type="text" id="client-name-internal" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2" placeholder="예: 구글 코리아">
                                </div>
                                <div>
                                    <label for="meeting-agenda" class="block text-sm md:text-base font-medium text-gray-600">미팅 안건</label>
                                    <input type="text" id="meeting-agenda" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2" placeholder="예: 구글 코리아 제안 전략 회의">
                                </div>
                                <div>
                                    <label for="author-name-internal" class="block text-sm md:text-base font-medium text-gray-600">작성자</label>
                                    <input type="text" id="author-name-internal" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2" placeholder="예: 김지훈">
                                </div>
                                <div>
                                    <label for="meeting-date-internal" class="block text-sm md:text-base font-medium text-gray-600">미팅 날짜</label>
                                    <input type="date" id="meeting-date-internal" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2">
                                </div>
                                <div>
                                    <label for="participants-internal" class="block text-sm md:text-base font-medium text-gray-600">미팅 참석자</label>
                                    <textarea id="participants-internal" rows="2" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-4" placeholder="예: 김지훈, 박민아, 이태형"></textarea>
                                </div>
                            </div>
                        </div>

                        <div class="space-y-6">
                            <div>
                                <label for="meeting-notes-internal" class="block text-sm md:text-base font-medium text-gray-600">미팅 내용</label>
                                <textarea id="meeting-notes-internal" rows="10" class="handwritten mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-4" placeholder="회의 내용 및 결정 사항을 자유롭게 기록하세요."></textarea>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 공통 항목 -->
                <div class="space-y-6 mt-8">
                    <!-- 추가 정보 필드 (양쪽 공통) -->
                    <div>
                        <label for="additional-notes" class="block text-sm md:text-base font-medium text-gray-600">추가 정보 / 자유 메모</label>
                        <textarea id="additional-notes" rows="4" class="handwritten mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-4" placeholder="구분되지 않은 기타 중요한 정보나 자유롭게 메모할 내용을 작성하세요."></textarea>
                    </div>
                    <!-- 첨부파일 섹션 추가 (양쪽 공통) -->
                    <div>
                        <label for="attachments" class="block text-sm md:text-base font-medium text-gray-600">첨부파일</label>
                        <input type="file" id="attachments" multiple class="mt-1 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
                        <div id="file-list-container" class="mt-2 space-y-1"></div>
                    </div>
                </div>
                
                <div class="flex justify-end mt-8">
                    <button id="save-btn-meeting" class="bg-blue-600 text-white font-semibold py-3 px-6 rounded-full shadow-lg hover:bg-blue-700 transition duration-300">
                        미팅 기록 저장
                    </button>
                    <button id="new-record-btn-meeting" class="ml-4 bg-gray-300 text-gray-800 font-semibold py-3 px-6 rounded-full shadow-lg hover:bg-gray-400 transition duration-300">
                        새 기록 작성
                    </button>
                </div>
            </section>
            
            <!-- 2. 기록 관리 탭 (CRUD) -->
            <section id="records-list" class="template-section bg-card p-6 md:p-12">
                <h2 class="text-2xl md:text-3xl font-bold mb-6 text-gray-800">기록 관리</h2>
                <div class="flex flex-wrap space-x-2 md:space-x-4 mb-8">
                    <button class="record-type-btn bg-blue-600 text-white font-semibold py-2 px-4 rounded-full" data-type="meeting">미팅 기록</button>
                    <button class="record-type-btn bg-gray-300 text-gray-800 font-semibold py-2 px-4 rounded-full" data-type="brainstorming">브레인스토밍</button>
                    <button class="record-type-btn bg-gray-300 text-gray-800 font-semibold py-2 px-4 rounded-full" data-type="crm">고객 관계도</button>
                    <button class="record-type-btn bg-gray-300 text-gray-800 font-semibold py-2 px-4 rounded-full" data-type="analysis">성공/실패 분석</button>
                </div>
                <div class="flex flex-wrap items-center space-x-4 mb-6">
                    <button id="export-btn" class="bg-indigo-600 text-white font-semibold py-2 px-4 rounded-full shadow-lg hover:bg-indigo-700 transition duration-300">
                        CSV로 내보내기
                    </button>
                    <input type="file" id="import-file-input" accept=".csv" class="hidden">
                    <button id="import-btn" class="bg-indigo-600 text-white font-semibold py-2 px-4 rounded-full shadow-lg hover:bg-indigo-700 transition duration-300">
                        CSV 가져오기
                    </button>
                </div>
                <div id="records-container" class="space-y-4">
                    <!-- 저장된 기록 목록이 여기에 동적으로 추가됩니다 -->
                </div>
                <p id="no-records-message" class="text-gray-500 text-center mt-8 hidden">저장된 기록이 없습니다.</p>
            </section>

            <!-- 3. 브레인스토밍 템플릿 -->
            <section id="brainstorming" class="template-section bg-card p-6 md:p-12 hidden">
                <h2 class="text-2xl md:text-3xl font-bold mb-6 text-gray-800">브레인스토밍</h2>
                <input type="hidden" id="current-record-id-brainstorming">
                <div class="bg-gray-50 p-6 rounded-2xl shadow-inner mb-6">
                    <label for="client-name-brainstorming" class="block text-sm md:text-base font-medium text-gray-600">고객사명 (연결)</label>
                    <input type="text" id="client-name-brainstorming" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2" placeholder="예: 구글 코리아">
                </div>
                <div class="space-y-6">
                    <div>
                        <h3 class="text-xl font-semibold mb-2 text-gray-700">문제 정의 & 핵심 질문</h3>
                        <p class="text-gray-500 text-sm mb-4">해결해야 할 핵심 문제를 명확히 정의하고, 아이디어를 발산하기 위한 질문을 던지세요.</p>
                        <textarea id="problem-define" rows="3" class="handwritten mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-4" placeholder="문제: &#10;질문:"></textarea>
                    </div>
                    <div>
                        <h3 class="text-xl font-semibold mb-2 text-gray-700">아이디어 발산 (마인드맵)</h3>
                        <p class="text-gray-500 text-sm mb-4">자유롭게 아이디어를 기록하고, 마인드맵을 그리거나 5W1H 방식으로 사고를 확장하세요.</p>
                        <textarea id="ideas" rows="10" class="handwritten mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-4" placeholder="핵심 문제 &#10; ├── 아이디어 1 &#10; │   ├── Why? &#10; │   └── How? &#10; ├── 아이디어 2 &#10; └── ..."></textarea>
                    </div>
                    <div>
                        <h3 class="text-xl font-semibold mb-2 text-gray-700">SWOT 분석</h3>
                        <div class="grid grid-cols-2 gap-4">
                            <div class="p-4 bg-white rounded-lg border">
                                <h4 class="font-bold mb-2 text-blue-600">강점 (Strengths)</h4>
                                <textarea id="swot-s" rows="3" class="w-full text-sm rounded-md border-gray-300 p-2" placeholder="우리의 강점은?"></textarea>
                            </div>
                            <div class="p-4 bg-white rounded-lg border">
                                <h4 class="font-bold mb-2 text-red-600">약점 (Weaknesses)</h4>
                                <textarea id="swot-w" rows="3" class="w-full text-sm rounded-md border-gray-300 p-2" placeholder="우리의 약점은?"></textarea>
                            </div>
                            <div class="p-4 bg-white rounded-lg border">
                                <h4 class="font-bold mb-2 text-green-600">기회 (Opportunities)</h4>
                                <textarea id="swot-o" rows="3" class="w-full text-sm rounded-md border-gray-300 p-2" placeholder="시장의 기회는?"></textarea>
                            </div>
                            <div class="p-4 bg-white rounded-lg border">
                                <h4 class="font-bold mb-2 text-gray-600">위협 (Threats)</h4>
                                <textarea id="swot-t" rows="3" class="w-full text-sm rounded-md border-gray-300 p-2" placeholder="경쟁사/시장 위협은?"></textarea>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="flex justify-end mt-8">
                    <button id="save-btn-brainstorming" class="bg-blue-600 text-white font-semibold py-3 px-6 rounded-full shadow-lg hover:bg-blue-700 transition duration-300">
                        브레인스토밍 저장
                    </button>
                    <button id="new-record-btn-brainstorming" class="ml-4 bg-gray-300 text-gray-800 font-semibold py-3 px-6 rounded-full shadow-lg hover:bg-gray-400 transition duration-300">
                        새 기록 작성
                    </button>
                </div>
            </section>

            <!-- 4. 고객 관계도 템플릿 -->
            <section id="crm" class="template-section bg-card p-6 md:p-12 hidden">
                <h2 class="text-2xl md:text-3xl font-bold mb-6 text-gray-800">고객 관계도</h2>
                <input type="hidden" id="current-record-id-crm">
                <div class="bg-gray-50 p-6 rounded-2xl shadow-inner mb-6">
                    <label for="client-name-crm" class="block text-sm md:text-base font-medium text-gray-600">고객사명 (연결)</label>
                    <input type="text" id="client-name-crm" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2" placeholder="예: 구글 코리아">
                </div>
                <p class="text-gray-500 mb-6">고객사 내 주요 인물들의 역할과 관계를 시각적으로 파악하세요.</p>
                <div id="crm-people-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <!-- 인물 카드 템플릿 -->
                </div>
                <div class="flex justify-start mt-4">
                    <button id="add-person-btn-crm" class="bg-green-600 text-white font-semibold py-2 px-4 rounded-full shadow-md hover:bg-green-700 transition duration-300">
                        인물 추가
                    </button>
                </div>
                <div class="flex justify-end mt-8">
                    <button id="save-btn-crm" class="bg-blue-600 text-white font-semibold py-3 px-6 rounded-full shadow-lg hover:bg-blue-700 transition duration-300">
                        고객 관계도 저장
                    </button>
                    <button id="new-record-btn-crm" class="ml-4 bg-gray-300 text-gray-800 font-semibold py-3 px-6 rounded-full shadow-lg hover:bg-gray-400 transition duration-300">
                        새 기록 작성
                    </button>
                </div>
            </section>

            <!-- 5. 성공/실패 분석 템플릿 -->
            <section id="analysis" class="template-section bg-card p-6 md:p-12 hidden">
                <h2 class="text-2xl md:text-3xl font-bold mb-6 text-gray-800">성공/실패 분석</h2>
                <input type="hidden" id="current-record-id-analysis">
                <div class="bg-gray-50 p-6 rounded-2xl shadow-inner mb-6">
                    <label for="client-name-analysis" class="block text-sm md:text-base font-medium text-gray-600">고객사명 (연결)</label>
                    <input type="text" id="client-name-analysis" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2" placeholder="예: 구글 코리아">
                </div>
                <div class="space-y-6">
                    <div>
                        <h3 class="text-xl font-semibold mb-2 text-gray-700">사례 개요</h3>
                        <p class="text-gray-500 text-sm mb-2">어떤 유형의 사례인지 선택하세요.</p>
                        <div class="mt-2 space-x-4">
                            <label class="inline-flex items-center">
                                <input type="radio" name="case-type" value="success" class="case-type-radio text-blue-500 focus:ring-blue-500">
                                <span class="ml-2 text-sm md:text-base">성공 사례</span>
                            </label>
                            <label class="inline-flex items-center">
                                <input type="radio" name="case-type" value="failure" class="case-type-radio text-blue-500 focus:ring-blue-500">
                                <span class="ml-2 text-sm md:text-base">실패 사례</span>
                            </label>
                        </div>
                        <textarea id="case-summary" rows="3" class="handwritten mt-4 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-4" placeholder="고객사명, 계약 규모, 주요 이슈를 요약하세요."></textarea>
                    </div>
                    <div>
                        <h3 class="text-xl font-semibold mb-2 text-gray-700">핵심 원인 분석</h3>
                        <p class="text-gray-500 text-sm mb-2">성공 또는 실패에 결정적인 영향을 미친 요인들을 분석하세요.</p>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <textarea id="my-action" rows="5" class="handwritten mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-4" placeholder="나의 행동: 내가 잘했거나 부족했던 점은?"></textarea>
                            <textarea id="customer-side" rows="5" class="handwritten mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-4" placeholder="고객 측 요인: 고객사의 내부/외부 환경 변화는?"></textarea>
                        </div>
                    </div>
                    <div>
                        <h3 class="text-xl font-semibold mb-2 text-gray-700">얻은 인사이트</h3>
                        <p class="text-gray-500 text-sm mb-2">이번 사례를 통해 배운 가장 중요한 교훈은 무엇인가요?</p>
                        <textarea id="insight" rows="5" class="handwritten mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-4" placeholder="다음 번에 적용할 구체적인 전략이나 교훈을 기록하세요."></textarea>
                    </div>
                </div>
                <div class="flex justify-end mt-8">
                    <button id="save-btn-analysis" class="bg-blue-600 text-white font-semibold py-3 px-6 rounded-full shadow-lg hover:bg-blue-700 transition duration-300">
                        분석 기록 저장
                    </button>
                    <button id="new-record-btn-analysis" class="ml-4 bg-gray-300 text-gray-800 font-semibold py-3 px-6 rounded-full shadow-lg hover:bg-gray-400 transition duration-300">
                        새 기록 작성
                    </button>
                </div>
            </section>
        </main>
    </div>

    <!-- ROI 계산 페이지 -->
    <div id="roi-page" class="hidden fixed top-0 left-0 w-full h-full bg-gray-50 p-4 md:p-8 overflow-y-auto">
        <div class="container mx-auto">
            <header class="flex items-center justify-between mb-8">
                <button id="back-to-main-btn" class="text-gray-600 text-2xl font-bold hover:text-gray-900 transition-colors">&larr; 뒤로가기</button>
                <h1 class="text-2xl md:text-3xl font-bold text-gray-800">ROI 계산기</h1>
            </header>
            <div class="bg-card p-6 md:p-12">
                <div class="mb-8">
                    <label for="roi-solution-select" class="block text-lg font-semibold text-gray-700 mb-2">솔루션 선택</label>
                    <select id="roi-solution-select" class="block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2 text-lg">
                        <option value="">솔루션을 선택하세요</option>
                        <option value="MES">MES</option>
                        <option value="EES">EES (설비 효율)</option>
                        <option value="EMS">EMS (설비 보전)</option>
                        <option value="EAP">EAP (TC)</option>
                    </select>
                </div>

                <div id="roi-inputs" class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8 hidden">
                    <!-- 입력 필드가 여기에 동적으로 추가됩니다 -->
                </div>

                <!-- 다년 ROI 계산 기간 입력 -->
                <div id="roi-period-input" class="mb-8 hidden">
                    <label for="calculation-period" class="block text-lg font-semibold text-gray-700 mb-2">ROI 계산 기간 (년)</label>
                    <input type="number" id="calculation-period" value="5" min="1" max="10" class="block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2 text-lg">
                </div>
                
                <div id="roi-results" class="hidden">
                    <h3 class="text-2xl font-bold mb-4 text-gray-800">ROI 분석 결과</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-6">
                        <div>
                            <p class="text-gray-700 mb-2">총 투자 비용: <span id="roi-cost" class="font-bold text-blue-600">0원</span></p>
                            <p class="text-gray-700">연간 예상 절감 효과: <span id="annual-savings" class="font-bold text-green-600">0원</span></p>
                            <p class="text-gray-700 mt-4 font-bold">투자금 회수 시점: <span id="payback-period" class="text-indigo-600">계산 중...</span></p>
                        </div>
                        <div class="bg-gray-100 p-4 rounded-xl flex flex-col justify-center items-center">
                            <p class="text-xl text-gray-700 font-semibold mb-1">총 ROI (<span id="roi-period-text">1년</span>)</p>
                            <span id="final-roi" class="text-4xl font-extrabold text-indigo-600">0.00%</span>
                        </div>
                    </div>
                    <div class="chart-container">
                        <canvas id="roiChart"></canvas>
                    </div>
                </div>

                <div class="flex justify-end mt-8">
                    <button id="calculate-roi-btn" class="bg-blue-600 text-white font-semibold py-3 px-6 rounded-full shadow-lg hover:bg-blue-700 transition duration-300">
                        ROI 계산
                    </button>
                    <button id="roi-reset-btn" class="ml-4 bg-gray-300 text-gray-800 font-semibold py-3 px-6 rounded-full shadow-lg hover:bg-gray-400 transition duration-300">
                        초기화
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 조회 모달 -->
    <div id="view-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <button class="absolute top-4 right-4 text-gray-500 hover:text-gray-800 text-2xl" onclick="closeModal()">
                &times;
            </button>
            <h3 class="text-2xl font-bold mb-4" id="modal-title"></h3>
            <div id="modal-details" class="space-y-4">
                <!-- 동적으로 내용이 채워질 영역 -->
            </div>
        </div>
    </div>

    <!-- JavaScript -->
    <script>
        // Service Worker 등록
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/service-worker.js').then(registration => {
                    console.log('Service Worker registered with scope:', registration.scope);
                }).catch(error => {
                    console.log('Service Worker registration failed:', error);
                });
            });
        }

        document.addEventListener('DOMContentLoaded', () => {
            const navLinks = document.querySelectorAll('.nav-link');
            const sections = document.querySelectorAll('.template-section');
            const recordsContainer = document.getElementById('records-container');
            const noRecordsMessage = document.getElementById('no-records-message');
            const viewModal = document.getElementById('view-modal');
            const modalDetails = document.getElementById('modal-details');
            const modalTitle = document.getElementById('modal-title');
            const recordTypeBtns = document.querySelectorAll('.record-type-btn');
            const salesStageRadios = document.querySelectorAll('input[name="sales-stage"]');
            const exportBtn = document.getElementById('export-btn');
            const mainLogo = document.getElementById('main-logo');
            const mainApp = document.getElementById('main-app');
            const roiPage = document.getElementById('roi-page');
            const backToMainBtn = document.getElementById('back-to-main-btn');
            
            let currentRecordType = 'meeting'; // 현재 선택된 기록 타입
            let roiChart = null; // 차트 인스턴스

            // ROI 계산을 위한 입력 필드 데이터
            const roiData = {
                MES: [
                    { label: "생산 효율 개선율 (%)", key: "efficiency", value: 10, type: "number" },
                    { label: "월 생산량 (단위)", key: "monthlyProduction", value: 10000, type: "number" },
                    { label: "단위 생산 비용 (원)", key: "unitCost", value: 500, type: "number" },
                    { label: "솔루션 도입 비용 (원)", key: "solutionCost", value: 20000000, type: "number" },
                    { label: "연간 유지보수 비용 (원)", key: "maintenanceCost", value: 3000000, type: "number" }
                ],
                EES: [
                    { label: "설비 가동률 개선율 (%)", key: "uptime", value: 5, type: "number" },
                    { label: "월 가동 시간 (시간)", key: "monthlyUptime", value: 200, type: "number" },
                    { label: "시간당 생산량 (단위)", key: "hourlyProduction", value: 50, type: "number" },
                    { label: "단위 생산 이익 (원)", key: "unitProfit", value: 1000, type: "number" },
                    { label: "솔루션 도입 비용 (원)", key: "solutionCost", value: 15000000, type: "number" },
                    { label: "연간 유지보수 비용 (원)", key: "maintenanceCost", value: 2000000, type: "number" }
                ],
                EMS: [
                    { label: "예지 보전으로 인한 절감 효과 (%)", key: "maintenanceSavings", value: 15, type: "number" },
                    { label: "연간 보전 비용 (원)", key: "annualMaintenanceCost", value: 50000000, type: "number" },
                    { label: "솔루션 도입 비용 (원)", key: "solutionCost", value: 25000000, type: "number" },
                    { label: "연간 유지보수 비용 (원)", key: "maintenanceCost", value: 4000000, type: "number" }
                ],
                EAP: [
                    { label: "TC 개선율 (%)", key: "tcImprovement", value: 10, type: "number" },
                    { label: "연간 TC 지출 비용 (원)", key: "annualTcCost", value: 30000000, type: "number" },
                    { label: "솔루션 도입 비용 (원)", key: "solutionCost", value: 10000000, type: "number" },
                    { label: "연간 유지보수 비용 (원)", key: "maintenanceCost", value: 1500000, type: "number" }
                ]
            };

            const forms = {
                meeting: {
                    id: document.getElementById('current-record-id-meeting'),
                    inputs: {
                        clientName: document.getElementById('client-name-meeting'),
                        contactName: document.getElementById('contact-name-meeting'),
                        authorName: document.getElementById('author-name'),
                        meetingDate: document.getElementById('meeting-date'),
                        expectedDeal: document.getElementById('expected-deal'),
                        salesStage: salesStageRadios,
                        desiredSystem: document.getElementById('desired-system'),
                        implementationTimeline: document.getElementById('implementation-timeline'),
                        decisionMethod: document.getElementById('decision-method'),
                        meetingMood: document.querySelectorAll('input[name="meeting-mood"]'),
                        keyQuestions: document.getElementById('key-questions'),
                        painPoint: document.getElementById('pain-point'),
                        needs: document.getElementById('needs'),
                        competitor: document.getElementById('competitor'),
                        nextAction: document.getElementById('next-action'),
                        additionalNotes: document.getElementById('additional-notes'),
                        proposalDetails: document.getElementById('proposal-details'),
                        customerObjections: document.getElementById('customer-objections'),
                        closingOutcome: document.getElementById('closing-outcome'),
                        attachments: document.getElementById('attachments'),
                        fileList: document.getElementById('file-list-container')
                    },
                    saveBtn: document.getElementById('save-btn-meeting'),
                    newBtn: document.getElementById('new-record-btn-meeting')
                },
                internal: { // 내부 미팅 폼 객체 추가
                    id: document.getElementById('current-record-id-internal'),
                    inputs: {
                        clientName: document.getElementById('client-name-internal'),
                        meetingAgenda: document.getElementById('meeting-agenda'),
                        authorName: document.getElementById('author-name-internal'),
                        meetingDate: document.getElementById('meeting-date-internal'),
                        participants: document.getElementById('participants-internal'),
                        meetingNotes: document.getElementById('meeting-notes-internal'),
                        additionalNotes: document.getElementById('additional-notes-internal')
                    },
                    saveBtn: document.getElementById('save-btn-internal'),
                    newBtn: document.getElementById('new-record-btn-internal')
                },
                brainstorming: {
                    id: document.getElementById('current-record-id-brainstorming'),
                    inputs: {
                        clientName: document.getElementById('client-name-brainstorming'),
                        problemDefine: document.getElementById('problem-define'),
                        ideas: document.getElementById('ideas'),
                        swotS: document.getElementById('swot-s'),
                        swotW: document.getElementById('swot-w'),
                        swotO: document.getElementById('swot-o'),
                        swotT: document.getElementById('swot-t')
                    },
                    saveBtn: document.getElementById('save-btn-brainstorming'),
                    newBtn: document.getElementById('new-record-btn-brainstorming')
                },
                crm: {
                    id: document.getElementById('current-record-id-crm'),
                    inputs: {
                        clientName: document.getElementById('client-name-crm'),
                        people: document.getElementById('crm-people-container')
                    },
                    addBtn: document.getElementById('add-person-btn-crm'),
                    saveBtn: document.getElementById('save-btn-crm'),
                    newBtn: document.getElementById('new-record-btn-crm')
                },
                analysis: {
                    id: document.getElementById('current-record-id-analysis'),
                    inputs: {
                        clientName: document.getElementById('client-name-analysis'),
                        caseType: document.querySelectorAll('input[name="case-type"]'),
                        caseSummary: document.getElementById('case-summary'),
                        myAction: document.getElementById('my-action'),
                        customerSide: document.getElementById('customer-side'),
                        insight: document.getElementById('insight')
                    },
                    saveBtn: document.getElementById('save-btn-analysis'),
                    newBtn: document.getElementById('new-record-btn-analysis')
                }
            };
            
            // 미팅 유형 선택 라디오 버튼
            const meetingTypeRadios = document.querySelectorAll('input[name="meeting-type"]');
            const customerMeetingFields = document.getElementById('customer-meeting-fields');
            const internalMeetingFields = document.getElementById('internal-meeting-fields');

            meetingTypeRadios.forEach(radio => {
                radio.addEventListener('change', (e) => {
                    const type = e.target.value;
                    if (type === 'customer') {
                        customerMeetingFields.classList.remove('hidden');
                        internalMeetingFields.classList.add('hidden');
                    } else {
                        customerMeetingFields.classList.add('hidden');
                        internalMeetingFields.classList.remove('hidden');
                    }
                });
            });

            // 영업 단계에 따라 폼 필드 동적으로 변경
            salesStageRadios.forEach(radio => {
                radio.addEventListener('change', () => {
                    updateMeetingFormFields(radio.value);
                });
            });

            // 초기 로드 시 폼 필드 설정
            updateMeetingFormFields(document.querySelector('input[name="sales-stage"][value="discovery"]').value);
            
            function updateMeetingFormFields(stage) {
                const allFields = document.querySelectorAll('#meeting-log .stage-fields');
                allFields.forEach(field => {
                    const stages = field.dataset.stage.split(' ');
                    if (stages.includes(stage)) {
                        field.classList.remove('hidden');
                    } else {
                        field.classList.add('hidden');
                    }
                });
            }


            // 탭 전환 로직
            navLinks.forEach(link => {
                link.addEventListener('click', (event) => {
                    event.preventDefault();
                    navLinks.forEach(item => item.classList.remove('active'));
                    event.currentTarget.classList.add('active');
                    sections.forEach(section => section.classList.add('hidden'));
                    const targetId = event.currentTarget.getAttribute('data-target');
                    document.getElementById(targetId).classList.remove('hidden');

                    if (targetId === 'records-list') {
                        loadRecordsList(currentRecordType);
                    } else if (targetId === 'crm') {
                        clearForm('crm');
                    } else {
                        clearForm(targetId.replace('-log', '')); // 폼 초기화
                    }
                });
            });
            
            // Win-Win-Log 로고 클릭 이벤트 (ROI 페이지 전환)
            mainLogo.addEventListener('click', () => {
                mainApp.classList.add('hidden');
                roiPage.classList.remove('hidden');
            });
            
            // ROI 페이지에서 메인으로 돌아가기
            backToMainBtn.addEventListener('click', () => {
                mainApp.classList.remove('hidden');
                roiPage.classList.add('hidden');
                // ROI 계산기 초기화
                document.getElementById('roi-solution-select').value = '';
                document.getElementById('roi-inputs').innerHTML = '';
                document.getElementById('roi-inputs').classList.add('hidden');
                document.getElementById('roi-results').classList.add('hidden');
            });


            // 기록 타입 버튼 클릭 로직
            recordTypeBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    recordTypeBtns.forEach(b => {
                        b.classList.remove('bg-blue-600', 'text-white');
                        b.classList.add('bg-gray-300', 'text-gray-800');
                    });
                    btn.classList.remove('bg-gray-300', 'text-gray-800');
                    btn.classList.add('bg-blue-600', 'text-white');
                    currentRecordType = btn.dataset.type;
                    loadRecordsList(currentRecordType);
                });
            });

            // 인물 추가 버튼 이벤트 (CRM)
            forms.crm.addBtn.addEventListener('click', () => {
                addPersonCard();
            });

            // 저장 버튼 이벤트 리스너
            document.getElementById('save-btn-meeting').addEventListener('click', () => {
                const type = document.querySelector('input[name="meeting-type"]:checked').value === 'customer' ? 'meeting' : 'internal';
                saveForm(type);
            });
            document.getElementById('new-record-btn-meeting').addEventListener('click', () => {
                const type = document.querySelector('input[name="meeting-type"]:checked').value === 'customer' ? 'meeting' : 'internal';
                clearForm(type);
            });

            forms.brainstorming.saveBtn.addEventListener('click', () => saveForm('brainstorming'));
            forms.brainstorming.newBtn.addEventListener('click', () => clearForm('brainstorming'));

            forms.crm.saveBtn.addEventListener('click', () => saveForm('crm'));
            forms.crm.newBtn.addEventListener('click', () => clearForm('crm'));

            forms.analysis.saveBtn.addEventListener('click', () => saveForm('analysis'));
            forms.analysis.newBtn.addEventListener('click', () => clearForm('analysis'));
            
            // Export 버튼 이벤트 리스너
            exportBtn.addEventListener('click', () => {
                exportToCsv();
            });

            // Import 버튼 이벤트 리스너
            document.getElementById('import-btn').addEventListener('click', () => {
                document.getElementById('import-file-input').click();
            });

            document.getElementById('import-file-input').addEventListener('change', (event) => {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        importFromCsv(e.target.result);
                    };
                    reader.readAsText(file);
                }
            });

            // CSV Export 함수
            function exportToCsv() {
                const dataToExport = {
                    meeting: JSON.parse(localStorage.getItem('b2b-meeting-records')) || {},
                    internal: JSON.parse(localStorage.getItem('b2b-internal-records')) || {},
                    brainstorming: JSON.parse(localStorage.getItem('b2b-brainstorming-records')) || {},
                    crm: JSON.parse(localStorage.getItem('b2b-crm-records')) || {},
                    analysis: JSON.parse(localStorage.getItem('b2b-analysis-records')) || {}
                };

                const allRecords = [];
                for (const type in dataToExport) {
                    for (const id in dataToExport[type]) {
                        const record = dataToExport[type][id];
                        // CSV에 적합하도록 JSON 데이터 가공
                        const flatRecord = {
                            id: record.id,
                            type: record.type,
                            timestamp: record.timestamp,
                            clientName: record.clientName,
                            contactName: record.contactName || '',
                            authorName: record.authorName || '',
                            meetingDate: record.meetingDate || '',
                            expectedDeal: record.expectedDeal || '',
                            salesStage: record.salesStage || '',
                            desiredSystem: record.desiredSystem || '',
                            implementationTimeline: record.implementationTimeline || '',
                            decisionMethod: record.decisionMethod || '',
                            meetingMood: record.meetingMood ? record.meetingMood.join(';') : '',
                            keyQuestions: record.keyQuestions ? record.keyQuestions.replace(/"/g, '""') : '',
                            painPoint: record.painPoint ? record.painPoint.replace(/"/g, '""') : '',
                            needs: record.needs ? record.needs.replace(/"/g, '""') : '',
                            competitor: record.competitor ? record.competitor.replace(/"/g, '""') : '',
                            nextAction: record.nextAction ? record.nextAction.replace(/"/g, '""') : '',
                            proposalDetails: record.proposalDetails ? record.proposalDetails.replace(/"/g, '""') : '',
                            customerObjections: record.customerObjections ? record.customerObjections.replace(/"/g, '""') : '',
                            closingOutcome: record.closingOutcome ? record.closingOutcome.replace(/"/g, '""') : '',
                            additionalNotes: record.additionalNotes ? record.additionalNotes.replace(/"/g, '""') : '',
                            attachments: record.attachments ? record.attachments.join(';') : '',
                            meetingAgenda: record.meetingAgenda || '',
                            participants: record.participants || '',
                            meetingNotes: record.meetingNotes ? record.meetingNotes.replace(/"/g, '""') : '',
                            crmPeople: record.people ? JSON.stringify(record.people).replace(/"/g, '""') : '',
                            caseType: record.caseType || '',
                            caseSummary: record.caseSummary ? record.caseSummary.replace(/"/g, '""') : '',
                            myAction: record.myAction ? record.myAction.replace(/"/g, '""') : '',
                            customerSide: record.customerSide ? record.customerSide.replace(/"/g, '""') : '',
                            insight: record.insight ? record.insight.replace(/"/g, '""') : ''
                        };
                        allRecords.push(flatRecord);
                    }
                }
                
                if (allRecords.length === 0) {
                    alert('내보낼 기록이 없습니다.');
                    return;
                }

                const headers = Object.keys(allRecords[0]);
                const csvContent = [
                    headers.join(','),
                    ...allRecords.map(row => headers.map(header => {
                        const value = row[header] !== undefined && row[header] !== null ? row[header] : '';
                        return `"${value}"`;
                    }).join(','))
                ].join('\n');

                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                if (link.download !== undefined) {
                    const url = URL.createObjectURL(blob);
                    link.setAttribute('href', url);
                    link.setAttribute('download', `Win-Win-Log_${new Date().toISOString().slice(0, 10)}.csv`);
                    link.style.visibility = 'hidden';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                }
            }

            // CSV Import 함수
            function importFromCsv(csvText) {
                const lines = csvText.split('\n');
                if (lines.length < 2) {
                    alert('유효한 CSV 파일이 아닙니다.');
                    return;
                }
                const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
                const newRecords = {};

                for (let i = 1; i < lines.length; i++) {
                    const line = lines[i].trim();
                    if (!line) continue;
                    const values = line.match(/(".*?"|[^",\s]+)(?=\s*,|\s*$)/g).map(v => v.replace(/"/g, ''));
                    const record = {};
                    headers.forEach((header, index) => {
                        let value = values[index];
                        if (value === 'true') value = true;
                        if (value === 'false') value = false;
                        if (header === 'meetingMood' || header === 'attachments') {
                            value = value ? value.split(';') : [];
                        } else if (header === 'crmPeople' && value) {
                            value = JSON.parse(value);
                        }
                        record[header] = value;
                    });
                    const type = record.type;
                    if (!newRecords[type]) {
                        newRecords[type] = {};
                    }
                    newRecords[type][record.id] = record;
                }

                if (Object.keys(newRecords).length > 0) {
                    if (confirm('기존 기록에 새로운 기록을 추가하시겠습니까? (덮어쓰기가 아닌 추가됩니다.)')) {
                        for (const type in newRecords) {
                            const key = `b2b-${type}-records`;
                            let existingRecords = JSON.parse(localStorage.getItem(key)) || {};
                            existingRecords = { ...existingRecords, ...newRecords[type] };
                            localStorage.setItem(key, JSON.stringify(existingRecords));
                        }
                        alert('기록을 성공적으로 가져왔습니다!');
                        loadRecordsList(currentRecordType);
                    }
                } else {
                    alert('가져올 유효한 기록이 없습니다.');
                }
            }

            // 인물 카드 생성 함수
            function createPersonCardHtml(person = {}) {
                const icon = person.name === '의사결정권자 (Decision Maker)' ? '👑' : person.name === '내부 챔피언 (Champion)' ? '💡' : person.name === '영향력 행사자 (Influencer)' ? '🗣️' : person.name === '잠재적 반대자 (Blocker)' ? '🚧' : '👤';
                const namePlaceholder = person.name || '';
                const titlePlaceholder = person.title || '';
                const rolePlaceholder = person.role || '';
                
                return `
                    <div class="bg-gray-50 p-4 rounded-2xl shadow-inner border border-gray-200 relative">
                        <button class="delete-person-btn absolute top-2 right-2 text-gray-400 hover:text-red-500 transition-colors" onclick="this.closest('.bg-gray-50').remove()">&times;</button>
                        <div class="flex items-center space-x-2 mb-2">
                            <span class="text-xl">${icon}</span>
                            <input type="text" class="person-name w-full text-lg font-bold p-1 rounded-md border-gray-300 focus:border-blue-500" placeholder="인물 이름" value="${namePlaceholder}">
                        </div>
                        <input type="text" class="person-title w-full text-sm p-1 rounded-md border-gray-300 focus:border-blue-500" placeholder="직위" value="${titlePlaceholder}">
                        <textarea rows="2" class="person-role w-full mt-2 text-sm p-1 rounded-md border-gray-300 focus:border-blue-500" placeholder="역할과 핵심 관심사">${rolePlaceholder}</textarea>
                    </div>
                `;
            }

            // 인물 카드 추가 함수
            function addPersonCard(person = {}) {
                const container = forms.crm.inputs.people;
                container.insertAdjacentHTML('beforeend', createPersonCardHtml(person));
            }
            
            // CRM 폼의 초기화 함수를 별도로 정의
            function initializeCrmForm() {
                const container = forms.crm.inputs.people;
                container.innerHTML = ''; // 기존 카드 모두 삭제
                // 기본 카드 4개 생성
                addPersonCard({ name: "의사결정권자 (Decision Maker)", title: "직위", role: "핵심 역할과 관심사" });
                addPersonCard({ name: "내부 챔피언 (Champion)", title: "직위", role: "우리 편에 서 있는 이유와 협력 방안" });
                addPersonCard({ name: "영향력 행사자 (Influencer)", title: "직위", role: "그들의 의견이 의사결정에 미치는 영향력" });
                addPersonCard({ name: "잠재적 반대자 (Blocker)", title: "직위", role: "반대 이유와 우려 사항" });
                
                forms.crm.id.value = '';
                forms.crm.inputs.clientName.value = '';
            }

            // 폼 데이터 수집 및 저장
            function saveForm(type) {
                const data = collectFormData(type);
                if (data) {
                    saveRecord(data, type);
                    alert('기록이 성공적으로 저장되었습니다!');
                    clearForm(type);
                    document.querySelector('[data-target="records-list"]').click();
                    loadRecordsList(type);
                } else {
                    alert('필수 정보를 입력해주세요.');
                }
            }

            // 데이터 수집 함수
            function collectFormData(type) {
                const form = forms[type];
                const id = form.id.value || Date.now().toString();
                let data = { id: id, type: type, timestamp: new Date().toISOString() };

                if (type === 'meeting') {
                    if (!form.inputs.clientName.value.trim() || !form.inputs.contactName.value.trim()) return null;
                    data.clientName = form.inputs.clientName.value.trim();
                    data.contactName = form.inputs.contactName.value.trim();
                    data.authorName = form.inputs.authorName.value.trim();
                    data.meetingDate = form.inputs.meetingDate.value;
                    data.expectedDeal = form.inputs.expectedDeal.value;
                    data.salesStage = Array.from(form.inputs.salesStage).find(radio => radio.checked)?.value || '';
                    data.desiredSystem = form.inputs.desiredSystem.value;
                    data.implementationTimeline = form.inputs.implementationTimeline.value;
                    data.decisionMethod = form.inputs.decisionMethod.value;
                    data.meetingMood = Array.from(form.inputs.meetingMood).filter(checkbox => checkbox.checked).map(checkbox => checkbox.value);
                    data.keyQuestions = form.inputs.keyQuestions.value;
                    data.painPoint = form.inputs.painPoint.value;
                    data.needs = form.inputs.needs.value;
                    data.competitor = form.inputs.competitor.value;
                    data.nextAction = form.inputs.nextAction.value;
                    data.proposalDetails = form.inputs.proposalDetails.value;
                    data.customerObjections = form.inputs.customerObjections.value;
                    data.closingOutcome = form.inputs.closingOutcome.value;
                    data.additionalNotes = form.inputs.additionalNotes.value;
                    // 첨부파일 이름 목록 저장 (파일 데이터는 저장하지 않음)
                    data.attachments = Array.from(form.inputs.attachments.files).map(file => file.name);
                } else if (type === 'internal') {
                    if (!form.inputs.meetingAgenda.value.trim() || !form.inputs.authorName.value.trim()) return null;
                    data.clientName = form.inputs.clientName.value.trim();
                    data.meetingAgenda = form.inputs.meetingAgenda.value.trim();
                    data.authorName = form.inputs.authorName.value.trim();
                    data.meetingDate = form.inputs.meetingDate.value;
                    data.participants = form.inputs.participants.value;
                    data.meetingNotes = form.inputs.meetingNotes.value;
                    data.additionalNotes = form.inputs.additionalNotes.value;
                } else if (type === 'brainstorming') {
                    if (!form.inputs.clientName.value.trim() || !form.inputs.problemDefine.value.trim()) return null;
                    data.clientName = form.inputs.clientName.value.trim();
                    data.problemDefine = form.inputs.problemDefine.value;
                    data.ideas = form.inputs.ideas.value;
                    data.swotS = form.inputs.swotS.value;
                    data.swotW = form.inputs.swotW.value;
                    data.swotO = form.inputs.swotO.value;
                    data.swotT = form.inputs.swotT.value;
                } else if (type === 'crm') {
                    if (!form.inputs.clientName.value.trim()) return null;
                    data.clientName = form.inputs.clientName.value.trim();
                    const peopleData = [];
                    const personCards = form.inputs.people.querySelectorAll('.bg-gray-50');
                    personCards.forEach(card => {
                        const person = {
                            name: card.querySelector('.person-name').value,
                            title: card.querySelector('.person-title').value,
                            role: card.querySelector('.person-role').value
                        };
                        peopleData.push(person);
                    });
                    data.people = peopleData;
                } else if (type === 'analysis') {
                    if (!form.inputs.clientName.value.trim() || !form.inputs.caseSummary.value.trim()) return null;
                    data.clientName = form.inputs.clientName.value.trim();
                    data.caseType = Array.from(form.inputs.caseType).find(radio => radio.checked)?.value || '';
                    data.caseSummary = form.inputs.caseSummary.value;
                    data.myAction = form.inputs.myAction.value;
                    data.customerSide = form.inputs.customerSide.value;
                    data.insight = form.inputs.insight.value;
                }
                return data;
            }

            // 폼 필드 초기화
            function clearForm(type) {
                const form = forms[type];
                form.id.value = '';
                if (type === 'meeting') {
                    form.inputs.clientName.value = '';
                    form.inputs.contactName.value = '';
                    form.inputs.authorName.value = '';
                    form.inputs.meetingDate.value = '';
                    form.inputs.expectedDeal.value = '';
                    form.inputs.salesStage.forEach(radio => radio.checked = false);
                    form.inputs.desiredSystem.value = '';
                    form.inputs.implementationTimeline.value = '';
                    form.inputs.decisionMethod.value = '';
                    form.inputs.meetingMood.forEach(checkbox => checkbox.checked = false);
                    form.inputs.keyQuestions.value = '';
                    form.inputs.painPoint.value = '';
                    form.inputs.needs.value = '';
                    form.inputs.competitor.value = '';
                    form.inputs.nextAction.value = '';
                    form.inputs.proposalDetails.value = '';
                    form.inputs.customerObjections.value = '';
                    form.inputs.closingOutcome.value = '';
                    form.inputs.additionalNotes.value = '';
                    forms.meeting.inputs.attachments.value = ''; // 파일 입력 필드 초기화
                    forms.meeting.inputs.fileList.innerHTML = ''; // 파일 목록 초기화
                    // 초기 상태로 UI 업데이트
                    document.querySelector('input[name="sales-stage"][value="discovery"]').checked = true;
                    updateMeetingFormFields('discovery');
                } else if (type === 'internal') {
                    form.inputs.clientName.value = '';
                    form.inputs.meetingAgenda.value = '';
                    form.inputs.authorName.value = '';
                    form.inputs.meetingDate.value = '';
                    form.inputs.participants.value = '';
                    form.inputs.meetingNotes.value = '';
                    form.inputs.additionalNotes.value = '';
                } else if (type === 'crm') {
                    initializeCrmForm();
                } else {
                    form.inputs.clientName.value = '';
                    for (const key in form.inputs) {
                        if (form.inputs[key] instanceof NodeList) {
                            form.inputs[key].forEach(radio => radio.checked = false);
                        } else if (typeof form.inputs[key] === 'object' && form.inputs[key].value !== undefined) {
                            form.inputs[key].value = '';
                        }
                    }
                }
            }

            // 로컬 스토리지에 데이터 저장/업데이트
            function saveRecord(data, type) {
                const key = `b2b-${type}-records`;
                let records = JSON.parse(localStorage.getItem(key)) || {};
                records[data.id] = data;
                localStorage.setItem(key, JSON.stringify(records));
            }

            // 기록 목록을 화면에 표시
            function loadRecordsList(type) {
                recordsContainer.innerHTML = '';
                const key = `b2b-${type}-records`;
                const records = JSON.parse(localStorage.getItem(key)) || {};
                const recordKeys = Object.keys(records).sort((a, b) => new Date(records[b].timestamp) - new Date(records[a].timestamp));

                if (recordKeys.length === 0) {
                    noRecordsMessage.classList.remove('hidden');
                    exportBtn.classList.add('hidden');
                } else {
                    noRecordsMessage.classList.add('hidden');
                    exportBtn.classList.remove('hidden');
                    recordKeys.forEach(key => {
                        const record = records[key];
                        const recordItem = document.createElement('div');
                        recordItem.className = 'flex flex-col md:flex-row items-start md:items-center justify-between bg-gray-100 p-4 rounded-xl shadow-sm border border-gray-200';
                        
                        let title = '';
                        let subInfo = `작성일: ${new Date(record.timestamp).toLocaleDateString()}`;

                        if (type === 'meeting') {
                            title = `[고객 미팅] ${record.clientName} - ${record.contactName}`;
                            subInfo += ` | 작성자: ${record.authorName || '미상'}`;
                        } else if (type === 'internal') {
                            title = `[내부 미팅] ${record.meetingAgenda}`;
                            subInfo += ` | 작성자: ${record.authorName || '미상'}`;
                        } else if (type === 'brainstorming') {
                            title = `[브레인스토밍] ${record.clientName}`;
                        } else if (type === 'crm') {
                            title = `[고객 관계도] ${record.clientName}`;
                        } else if (type === 'analysis') {
                            title = `[분석] ${record.clientName}`;
                        }
                        
                        recordItem.innerHTML = `
                            <div>
                                <h4 class="font-bold text-lg text-gray-800">${title}</h4>
                                <p class="text-sm text-gray-500">${subInfo}</p>
                            </div>
                            <div class="mt-4 md:mt-0 md:ml-4 flex space-x-2">
                                <button class="view-btn bg-blue-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-blue-600 transition" data-id="${record.id}" data-type="${type}">상세 보기</button>
                                <button class="edit-btn bg-yellow-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-yellow-600 transition" data-id="${record.id}" data-type="${type}">수정</button>
                                <button class="delete-btn bg-red-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-red-600 transition" data-id="${record.id}" data-type="${type}">삭제</button>
                            </div>
                        `;
                        recordsContainer.appendChild(recordItem);
                    });

                    // 동적으로 생성된 버튼에 이벤트 리스너 추가
                    document.querySelectorAll('.view-btn').forEach(button => {
                        button.addEventListener('click', (event) => showDetailsModal(event.target.dataset.id, event.target.dataset.type));
                    });
                    document.querySelectorAll('.edit-btn').forEach(button => {
                        button.addEventListener('click', (event) => {
                            loadRecord(event.target.dataset.id, event.target.dataset.type);
                            document.querySelector(`[data-target="${event.target.dataset.type}"]`).click();
                        });
                    });
                    document.querySelectorAll('.delete-btn').forEach(button => {
                        button.addEventListener('click', (event) => {
                            if (confirm('정말로 이 기록을 삭제하시겠습니까?')) {
                                deleteRecord(event.target.dataset.id, event.target.dataset.type);
                                loadRecordsList(event.target.dataset.type);
                            }
                        });
                    });
                }
            }

            // 특정 기록을 폼에 불러오기 (수정 기능)
            function loadRecord(id, type) {
                const key = `b2b-${type}-records`;
                const records = JSON.parse(localStorage.getItem(key));
                if (records && records[id]) {
                    const data = records[id];
                    const form = forms[type];
                    form.id.value = data.id;
                    if (type === 'meeting') {
                        document.querySelector('input[name="meeting-type"][value="customer"]').checked = true;
                        form.inputs.clientName.value = data.clientName;
                        form.inputs.contactName.value = data.contactName;
                        form.inputs.authorName.value = data.authorName;
                        form.inputs.meetingDate.value = data.meetingDate;
                        form.inputs.expectedDeal.value = data.expectedDeal;
                        form.inputs.salesStage.forEach(radio => radio.checked = radio.value === data.salesStage);
                        form.inputs.desiredSystem.value = data.desiredSystem;
                        form.inputs.implementationTimeline.value = data.implementationTimeline;
                        form.inputs.decisionMethod.value = data.decisionMethod;
                        form.inputs.meetingMood.forEach(checkbox => checkbox.checked = data.meetingMood.includes(checkbox.value));
                        form.inputs.keyQuestions.value = data.keyQuestions;
                        form.inputs.painPoint.value = data.painPoint;
                        form.inputs.needs.value = data.needs;
                        form.inputs.competitor.value = data.competitor;
                        form.inputs.nextAction.value = data.nextAction;
                        form.inputs.proposalDetails.value = data.proposalDetails;
                        form.inputs.customerObjections.value = data.customerObjections;
                        form.inputs.closingOutcome.value = data.closingOutcome;
                        form.inputs.additionalNotes.value = data.additionalNotes;
                        
                        form.inputs.fileList.innerHTML = '';
                        if (data.attachments && data.attachments.length > 0) {
                            data.attachments.forEach(fileName => {
                                const fileItem = document.createElement('div');
                                fileItem.className = 'text-sm text-gray-600';
                                fileItem.innerText = `📁 ${fileName}`;
                                form.inputs.fileList.appendChild(fileItem);
                            });
                        }
                        updateMeetingFormFields(data.salesStage);
                    } else if (type === 'internal') {
                        document.querySelector('input[name="meeting-type"][value="internal"]').checked = true;
                        form.inputs.clientName.value = data.clientName;
                        form.inputs.meetingAgenda.value = data.meetingAgenda;
                        form.inputs.authorName.value = data.authorName;
                        form.inputs.meetingDate.value = data.meetingDate;
                        form.inputs.participants.value = data.participants;
                        form.inputs.meetingNotes.value = data.meetingNotes;
                        form.inputs.additionalNotes.value = data.additionalNotes;
                    } else if (type === 'crm') {
                        form.inputs.clientName.value = data.clientName;
                        form.inputs.people.innerHTML = '';
                        data.people.forEach(person => addPersonCard(person));
                    } else {
                        form.inputs.clientName.value = data.clientName;
                        for (const key in form.inputs) {
                            if (form.inputs[key] instanceof NodeList) {
                                form.inputs[key].forEach(radio => radio.checked = radio.value === data[key]);
                            } else if (typeof form.inputs[key] === 'object' && form.inputs[key].value !== undefined) {
                                form.inputs[key].value = data[key];
                            }
                        }
                    }
                }
            }

            // 특정 기록을 삭제
            function deleteRecord(id, type) {
                const key = `b2b-${type}-records`;
                const records = JSON.parse(localStorage.getItem(key));
                if (records && records[id]) {
                    delete records[id];
                    localStorage.setItem(key, JSON.stringify(records));
                    alert('기록이 삭제되었습니다.');
                }
            }

            // 상세 보기 모달 표시
            function showDetailsModal(id, type) {
                const key = `b2b-${type}-records`;
                const records = JSON.parse(localStorage.getItem(key));
                const data = records[id];
                if (data) {
                    modalDetails.innerHTML = '';
                    if (type === 'meeting') {
                        modalTitle.innerText = `미팅 기록: ${data.clientName}`;
                        const attachmentsHtml = data.attachments && data.attachments.length > 0 ?
                            `
                            <h4 class="font-bold text-gray-700 mb-2 mt-4">첨부파일</h4>
                            <ul class="list-disc list-inside space-y-1">
                                ${data.attachments.map(file => `<li><a href="#" class="text-blue-600 hover:underline" onclick="event.preventDefault(); alert('이 기능은 실제 서버가 필요합니다. 파일 이름: ${file}');">📁 ${file}</a></li>`).join('')}
                            </ul>
                            ` :
                            '';
                        modalDetails.innerHTML = `
                            <p class="text-gray-500 text-sm mb-1">고객사명: <span class="text-gray-800 font-semibold">${data.clientName}</span></p>
                            <p class="text-gray-500 text-sm mb-1">담당자: <span class="text-gray-800 font-semibold">${data.contactName}</span></p>
                            <p class="text-gray-500 text-sm mb-1">작성자: <span class="text-gray-800 font-semibold">${data.authorName || '미상'}</span></p>
                            <p class="text-gray-500 text-sm mb-1">작성일: <span class="text-gray-800 font-semibold">${new Date(data.timestamp).toLocaleDateString() || '미상'}</span></p>
                            <p class="text-gray-500 text-sm mb-1">미팅 날짜: <span class="text-gray-800 font-semibold">${data.meetingDate || '미상'}</span></p>
                            <p class="text-gray-500 text-sm mb-1">영업 단계: <span class="text-gray-800 font-semibold">${data.salesStage || '미상'}</span></p>
                            <p class="text-gray-500 text-sm mb-1">원하는 시스템: <span class="text-gray-800 font-semibold">${data.desiredSystem || '미상'}</span></p>
                            <p class="text-gray-500 text-sm mb-1">도입 시점: <span class="text-gray-800 font-semibold">${data.implementationTimeline || '미상'}</span></p>
                            <p class="text-gray-500 text-sm mb-1">의사결정 방식: <span class="text-gray-800 font-semibold">${data.decisionMethod || '미상'}</span></p>
                            <p class="text-gray-500 text-sm mb-1">미팅 분위기: <span class="text-gray-800 font-semibold">${data.meetingMood?.join(', ') || '미상'}</span></p>
                            <h4 class="font-bold text-gray-700 mb-2 mt-4">핵심 질문 기록</h4>
                            <p class="whitespace-pre-wrap">${data.keyQuestions || '없음'}</p>
                            <h4 class="font-bold text-gray-700 mb-2 mt-4">고객의 Pain Point</h4>
                            <p class="whitespace-pre-wrap">${data.painPoint || '없음'}</p>
                            <h4 class="font-bold text-gray-700 mb-2 mt-4">고객의 Needs & Goals</h4>
                            <p class="whitespace-pre-wrap">${data.needs || '없음'}</p>
                            <h4 class="font-bold text-gray-700 mb-2 mt-4">주요 제안 내용 및 협상</h4>
                            <p class="whitespace-pre-wrap">${data.proposalDetails || '없음'}</p>
                            <h4 class="font-bold text-gray-700 mb-2 mt-4">고객의 주요 반대 의견</h4>
                            <p class="whitespace-pre-wrap">${data.customerObjections || '없음'}</p>
                            <h4 class="font-bold text-gray-700 mb-2 mt-4">계약 결과 및 요인</h4>
                            <p class="whitespace-pre-wrap">${data.closingOutcome || '없음'}</p>
                            <h4 class="font-bold text-gray-700 mb-2 mt-4">경쟁사 언급</h4>
                            <p class="whitespace-pre-wrap">${data.competitor || '없음'}</p>
                            <h4 class="font-bold text-gray-700 mb-2 mt-4">다음 행동 계획</h4>
                            <p class="whitespace-pre-wrap">${data.nextAction || '없음'}</p>
                            <h4 class="font-bold text-gray-700 mb-2 mt-4">추가 정보 / 자유 메모</h4>
                            <p class="whitespace-pre-wrap">${data.additionalNotes || '없음'}</p>
                            ${attachmentsHtml}
                        `;
                    } else if (type === 'internal') {
                        modalTitle.innerText = `내부 미팅: ${data.meetingAgenda}`;
                        modalDetails.innerHTML = `
                            <p class="text-gray-500 text-sm mb-1">미팅 안건: <span class="text-gray-800 font-semibold">${data.meetingAgenda}</span></p>
                            <p class="text-gray-500 text-sm mb-1">고객사명 (관련): <span class="text-gray-800 font-semibold">${data.clientName || '미상'}</span></p>
                            <p class="text-gray-500 text-sm mb-1">작성자: <span class="text-gray-800 font-semibold">${data.authorName || '미상'}</span></p>
                            <p class="text-gray-500 text-sm mb-1">작성일: <span class="text-gray-800 font-semibold">${new Date(data.timestamp).toLocaleDateString() || '미상'}</span></p>
                            <p class="text-gray-500 text-sm mb-1">미팅 날짜: <span class="text-gray-800 font-semibold">${data.meetingDate || '미상'}</span></p>
                            <p class="text-gray-500 text-sm mb-1">참석자: <span class="text-gray-800 font-semibold">${data.participants || '미상'}</span></p>
                            <hr class="my-4">
                            <h4 class="font-bold text-gray-700 mb-2">미팅 내용</h4>
                            <p class="whitespace-pre-wrap">${data.meetingNotes || '없음'}</p>
                            <h4 class="font-bold text-gray-700 mb-2 mt-4">추가 정보 / 자유 메모</h4>
                            <p class="whitespace-pre-wrap">${data.additionalNotes || '없음'}</p>
                        `;
                    } else if (type === 'brainstorming') {
                        modalTitle.innerText = `브레인스토밍: ${data.clientName}`;
                        modalDetails.innerHTML = `
                            <p class="text-gray-500 text-sm mb-1">고객사명: <span class="text-gray-800 font-semibold">${data.clientName}</span></p>
                            <p class="text-gray-500 text-sm mb-1">작성일: <span class="text-gray-800 font-semibold">${new Date(data.timestamp).toLocaleDateString() || '미상'}</span></p>
                            <hr class="my-4">
                            <h4 class="font-bold text-gray-700 mb-2">문제 정의 & 핵심 질문</h4>
                            <p class="whitespace-pre-wrap">${data.problemDefine || '없음'}</p>
                            <h4 class="font-bold text-gray-700 mb-2 mt-4">아이디어 발산</h4>
                            <p class="whitespace-pre-wrap">${data.ideas || '없음'}</p>
                            <h4 class="font-bold text-gray-700 mb-2 mt-4">SWOT 분석</h4>
                            <p class="text-gray-800 font-semibold">강점: <span class="font-normal">${data.swotS || '없음'}</span></p>
                            <p class="text-gray-800 font-semibold">약점: <span class="font-normal">${data.swotW || '없음'}</span></p>
                            <p class="text-gray-800 font-semibold">기회: <span class="font-normal">${data.swotO || '없음'}</span></p>
                            <p class="text-gray-800 font-semibold">위협: <span class="font-normal">${data.swotT || '없음'}</span></p>
                        `;
                    } else if (type === 'crm') {
                        modalTitle.innerText = `고객 관계도: ${data.clientName}`;
                        modalDetails.innerHTML = `
                            <p class="text-gray-500 text-sm mb-1">고객사명: <span class="text-gray-800 font-semibold">${data.clientName}</span></p>
                            <p class="text-gray-500 text-sm mb-1">작성일: <span class="text-gray-800 font-semibold">${new Date(data.timestamp).toLocaleDateString() || '미상'}</span></p>
                            <hr class="my-4">
                            <h4 class="font-bold text-gray-700 mb-2">인물 정보</h4>
                            <ul class="list-disc list-inside space-y-2">
                                ${data.people.map(p => `<li><span class="font-semibold">${p.name || '미상'} (${p.title || '미상'}):</span> ${p.role || '역할 정보 없음'}</li>`).join('')}
                            </ul>
                        `;
                    } else if (type === 'analysis') {
                        modalTitle.innerText = `분석: ${data.clientName}`;
                        modalDetails.innerHTML = `
                            <p class="text-gray-500 text-sm mb-1">고객사명: <span class="text-gray-800 font-semibold">${data.clientName}</span></p>
                            <p class="text-gray-500 text-sm mb-1">작성일: <span class="text-gray-800 font-semibold">${new Date(data.timestamp).toLocaleDateString() || '미상'}</span></p>
                            <p class="text-gray-500 text-sm mb-1">유형: <span class="text-gray-800 font-semibold">${data.caseType || '미상'}</span></p>
                            <hr class="my-4">
                            <h4 class="font-bold text-gray-700 mb-2">사례 요약</h4>
                            <p class="whitespace-pre-wrap">${data.caseSummary || '없음'}</p>
                            <h4 class="font-bold text-gray-700 mb-2 mt-4">핵심 원인 분석</h4>
                            <p class="text-gray-800 font-semibold">나의 행동: <span class="font-normal whitespace-pre-wrap">${data.myAction || '없음'}</span></p>
                            <p class="text-gray-800 font-semibold">고객 측 요인: <span class="font-normal whitespace-pre-wrap">${data.customerSide || '없음'}</span></p>
                            <h4 class="font-bold text-gray-700 mb-2 mt-4">얻은 인사이트</h4>
                            <p class="whitespace-pre-wrap">${data.insight || '없음'}</p>
                        `;
                    }
                    viewModal.classList.remove('hidden');
                }
            }

            window.closeModal = () => {
                viewModal.classList.add('hidden');
            };

            // 초기 로드 시 미팅 기록 목록을 보여줍니다.
            loadRecordsList('meeting');
            
            // ROI 계산기 로직
            const roiSolutionSelect = document.getElementById('roi-solution-select');
            const roiInputsContainer = document.getElementById('roi-inputs');
            const roiPeriodInput = document.getElementById('roi-period-input');
            const roiResults = document.getElementById('roi-results');
            const calculateRoiBtn = document.getElementById('calculate-roi-btn');
            const roiResetBtn = document.getElementById('roi-reset-btn');
            const roiPeriodText = document.getElementById('roi-period-text');
            const paybackPeriodEl = document.getElementById('payback-period');
            const roiCostEl = document.getElementById('roi-cost');
            const annualSavingsEl = document.getElementById('annual-savings');
            
            roiSolutionSelect.addEventListener('change', (e) => {
                const solution = e.target.value;
                roiInputsContainer.innerHTML = '';
                if (solution) {
                    roiData[solution].forEach(item => {
                        const div = document.createElement('div');
                        div.className = 'roi-input-field';
                        div.innerHTML = `
                            <label for="${item.key}">${item.label}</label>
                            <input type="${item.type}" id="${item.key}" value="${item.value}" class="block w-full text-lg rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2 mt-1">
                        `;
                        roiInputsContainer.appendChild(div);
                    });
                    roiInputsContainer.classList.remove('hidden');
                    roiPeriodInput.classList.remove('hidden');
                } else {
                    roiInputsContainer.classList.add('hidden');
                    roiPeriodInput.classList.add('hidden');
                }
                roiResults.classList.add('hidden'); // 솔루션 변경 시 결과 숨기기
            });

            calculateRoiBtn.addEventListener('click', () => {
                const solution = roiSolutionSelect.value;
                if (!solution) {
                    alert("솔루션을 선택해주세요.");
                    return;
                }

                const period = parseInt(document.getElementById('calculation-period').value);
                if (isNaN(period) || period < 1 || period > 10) {
                    alert("계산 기간은 1년에서 10년 사이의 숫자를 입력해주세요.");
                    return;
                }

                let annualSavings = 0;
                let initialCost = 0;
                let annualMaintenanceCost = 0;

                const inputValues = {};
                roiData[solution].forEach(item => {
                    inputValues[item.key] = parseFloat(document.getElementById(item.key).value);
                });

                initialCost = inputValues.solutionCost;
                annualMaintenanceCost = inputValues.maintenanceCost || 0;


                if (solution === "MES") {
                    annualSavings = (inputValues.monthlyProduction * inputValues.unitCost * (inputValues.efficiency / 100)) * 12;
                } else if (solution === "EES") {
                    annualSavings = (inputValues.monthlyUptime * (inputValues.uptime / 100)) * inputValues.hourlyProduction * inputValues.unitProfit * 12;
                } else if (solution === "EMS") {
                    annualSavings = inputValues.annualMaintenanceCost * (inputValues.maintenanceSavings / 100);
                } else if (solution === "EAP") {
                    annualSavings = inputValues.annualTcCost * (inputValues.tcImprovement / 100);
                }
                
                const cumulativeSavings = [];
                const cumulativeCost = [];
                const cumulativeRoi = [];
                let paybackPeriod = "계산 불가";
                
                let currentTotalCost = 0;
                let paybackFound = false;

                for (let i = 1; i <= period; i++) {
                    currentTotalCost = initialCost + (annualMaintenanceCost * i);
                    
                    const currentYearSavings = annualSavings * i;
                    
                    cumulativeCost.push(currentTotalCost);
                    cumulativeSavings.push(currentYearSavings);
                    
                    const currentRoi = ((currentYearSavings - currentTotalCost) / currentTotalCost) * 100;
                    cumulativeRoi.push(currentRoi);
                    
                    if (currentTotalSavings >= currentTotalCost && !paybackFound) {
                        const netAnnualBenefit = annualSavings - annualMaintenanceCost;
                        const years = netAnnualBenefit > 0 ? initialCost / netAnnualBenefit : Infinity;
                        
                        const paybackYears = Math.floor(years);
                        const months = Math.round((years % 1) * 12);
                        
                        paybackPeriod = paybackYears > 0 ? `${paybackYears}년 ${months}개월` : `${months}개월`;
                        paybackFound = true;
                    }
                }
                
                if (annualSavings <= annualMaintenanceCost) {
                    paybackPeriod = "투자금 회수 불가능";
                }
                
                const finalRoiValue = cumulativeRoi[period - 1] || 0;
                const finalCost = cumulativeCost[period-1] || 0;
                
                roiCostEl.innerText = `${finalCost.toLocaleString()}원`;
                annualSavingsEl.innerText = `${annualSavings.toLocaleString()}원`;
                roiPeriodText.innerText = `${period}년`;
                document.getElementById('final-roi').innerText = `${finalRoiValue.toFixed(2)}%`;
                paybackPeriodEl.innerText = paybackPeriod;
                
                roiResults.classList.remove('hidden');
                drawRoiChart(cumulativeSavings, cumulativeCost, period);
            });
            
            roiResetBtn.addEventListener('click', () => {
                roiSolutionSelect.value = '';
                roiInputsContainer.innerHTML = '';
                roiInputsContainer.classList.add('hidden');
                roiPeriodInput.classList.add('hidden');
                roiResults.classList.add('hidden');
            });
            
            function drawRoiChart(cumulativeSavings, cumulativeCost, period) {
                const ctx = document.getElementById('roiChart').getContext('2d');
                if (roiChart) {
                    roiChart.destroy(); // 기존 차트가 있으면 삭제
                }
                
                const years = Array.from({ length: period }, (_, i) => `${i + 1}년`);

                roiChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: years,
                        datasets: [
                            {
                                label: '누적 투자 비용',
                                data: cumulativeCost,
                                borderColor: 'rgba(255, 99, 132, 1)',
                                backgroundColor: 'rgba(255, 99, 132, 0.2)',
                                borderWidth: 2,
                                fill: false,
                                pointRadius: 5,
                                pointHoverRadius: 8,
                            },
                            {
                                label: '누적 절감 효과',
                                data: cumulativeSavings,
                                borderColor: 'rgba(75, 192, 192, 1)',
                                backgroundColor: 'rgba(75, 192, 192, 0.2)',
                                borderWidth: 2,
                                fill: true,
                                tension: 0.4,
                                pointRadius: 5,
                                pointHoverRadius: 8,
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: true
                            },
                            title: {
                                display: true,
                                text: '연도별 투자금 회수 분석',
                                font: { size: 18 }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: function(value) {
                                        return value.toLocaleString() + '원';
                                    }
                                }
                            }
                        }
                    }
                });
            }

        });
    </script>
</body>
</html>
